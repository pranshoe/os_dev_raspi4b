#ifndef EMMC_H
#define EMMC_H

#include "peripheral.h"

enum{
    EMMC_BASE = (PERIPHERAL_BASE + EMMC_OFFSET),

    EMMC_ARG2 = (EMMC_BASE),
    EMMC_BLKSIZECNT = (EMMC_BASE + 0x04),
    EMMC_ARG1 = (EMMC_BASE + 0x08),
    EMMC_CMDTM = (EMMC_BASE + 0x0C),
    EMMC_RESP0 = (EMMC_BASE + 0x10),
    EMMC_RESP1 = (EMMC_BASE + 0x14),
    EMMC_RESP2 = (EMMC_BASE + 0x18),
    EMMC_RESP3 = (EMMC_BASE + 0x1C),
    EMMC_DATA = (EMMC_BASE + 0x20),
    EMMC_STATUS = (EMMC_BASE + 0x24),
    EMMC_CONTROL0 = (EMMC_BASE + 0x28),
    EMMC_CONTROL1 = (EMMC_BASE + 0x2C),
    EMMC_INTERRUPT = (EMMC_BASE + 0x30),
    EMMC_INT_MASK = (EMMC_BASE + 0x34),
    EMMC_INT_EN = (EMMC_BASE + 0x38),
    EMMC_CONTROL2 = (EMMC_BASE + 0x3C),
    EMMC_SLOTISR_VER = (EMMC_BASE + 0xFC)
};

typedef enum{
    CMD_NEED_APP = 0x80000000,
    CMD_RSPNS_48 = 0x00020000,
    CMD_ERRORS_MASK = 0xfff9c004,
    CMD_RCA_MASK = 0xffff0000
} cmd_flags;

typedef enum{
    CMD_GO_IDLE = 0x00000000,
    CMD_ALL_SEND_CID = 0x02010000,
    CMD_SEND_REL_ADDR = 0x03020000,
    CMD_CARD_SELECT = 0x07030000,
    CMD_SEND_IF_COND = 0x08020000,
    CMD_STOP_TRANS = 0x0C030000,
    CMD_READ_SINGLE = 0x11220010,
    CMD_READ_MULTI = 0x12220032,
    CMD_SET_BLOKCNT = 0x17020000,
    CMD_APP_CMD = 0x37000000,
    CMD_SET_BUS_WIDTH = (0x06020000 | CMD_NEED_APP),
    CMD_SEND_OP_COND = (0x29020000 | CMD_NEED_APP),
    CMD_SEND_SCR = (0x33220010 | CMD_NEED_APP)
} cmd;

enum{
    SR_READ_AVAILABLE = 0x00000800,
    SR_DAT_INHIBIT = 0x00000002,
    SR_CMD_INHIBIT = 0x00000001,
    SR_APP_CMD = 0x00000020
};

enum{
    INT_DATA_TIMEOUT = 0x00100000,
    INT_CMD_TIMEOUT = 0x00010000,
    INT_READ_RDY = 0x00000020,
    INT_CMD_DONE = 0x00000001,

    INT_ERROR_MASK = 0x017E8000
};

typedef enum{
    C0_SPI_MODE_EN = 0x00100000,
    C0_HCTL_HS_EN = 0x00000004,
    C0_HCTL_DWIDTH = 0x00000002
} control0_set;

typedef enum{
    C1_SRST_DATA = 0x04000000,
    C1_SRST_CMD = 0x02000000,
    C1_SRST_HC = 0x01000000,
    C1_TOUNIT_DIS = 0x000f0000,
    C1_TOUNIT_MAX = 0x000e0000,
    C1_CLK_GENSEL = 0x00000020,
    C1_CLK_EN = 0x00000004,
    C1_CLK_STABLE = 0x00000002,
    C1_CLK_INTLEN = 0x00000001
} control1_set;

enum{
    HOST_SPEC_NUM = 0x00ff8000,
    HOST_SPEC_NUM_SHIFT = 16,
    HOST_SPEC_V3 = 2,
    HOST_SPEC_V2 = 1,
    HOST_SPEC_V1 = 0
};

enum{
    SCR_SD_BUS_WIDTH_4 = 0x00000400,
    SCR_SUPP_SET_BLKCNT = 0x02000000,
    SCR_SUPP_CCS = 0x00000001
};

enum{
    ACMD41_VOLTAGE = 0x00ff8000,
    ACMD41_CMD_COMPLETE = 0x80000000,
    ACMD41_CMD_CCS = 0x40000000,
    ACMD41_ARG_HC = 0x51ff8000
};

enum{
    SD_OK = 0,
    SD_TIMEOUT = -1,
    SD_ERROR = -2
};

#define BLOCK_SIZE  512

int sd_readblk(unsigned int ba, unsigned char *buffer, unsigned int num);
int sd_init();

#endif